#!/usr/bin/env bash

set -e

if [[ ! $(command -v aws-ec2-list) ]]; then
  gem install aws-ec2-list
fi
  
if [[ ! $(command -v fzf) ]]; then
  brew install fzf
fi

env='integration'
console=false
copy_domain=false

if [[ $* =~ 'production' ]]; then
  env='production'
fi

if [[ $* =~ 'console' ]]; then
  console=true
fi

if [[ $* =~ 'copy' ]]; then
  copy_domain=true
fi

if [[ $env == 'production' ]]; then
  region='us-east-1'
else
  region='us-west-2'
fi

domain=$(
  aws-ec2-list --region=$region --columns='public_dns_name, stack_name, project, state' |\
  grep 'running' |\
  fzf --header='Select EC2 instance' --query="lp-webapp-${env}" |\
  awk -F ' | ' '{print $1}'
)

if [[ $domain != '' ]]; then
  if $console; then
    tmux_command="tmux new 'sudo -u unbounce RAILS_ENV=${env} bundle exec rails console'"
  else
    tmux_command="tmux new 'sudo su - unbounce'"
  fi

  if $copy_domain; then
    echo "ubadmin@${domain}" | pbcopy
  else
    ssh -oStrictHostKeyChecking=accept-new ubadmin@"$domain" \
      -t "cd /opt/lp-webapp/current && $tmux_command"
  fi
fi
