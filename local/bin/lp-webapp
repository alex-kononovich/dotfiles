#!/usr/bin/env bash

set -e

# if [[ ! $(command -v aws-ec2-list) ]]; then
#   gem install aws-ec2-list
# fi
  
# if [[ ! $(command -v fzf) ]]; then
#   brew install fzf
# fi

env='integration'
console=false

if [[ $* =~ 'production' ]]; then
  env='production'
fi

if [[ $* =~ 'console' ]]; then
  console=true
fi

if [[ $env == 'production' ]]; then
  region='us-east-1'
else
  region='us-west-2'
fi

domain=$(
  aws-ec2-list --region=$region --columns='public_dns_name, stack_name, project, state' |\
  grep 'running' |\
  fzf --header='Select EC2 instance' --query="lp-webapp-${env}" |\
  awk -F ' | ' '{print $1}'
)

if [[ $domain != '' ]]; then
  if $console; then
    command="RAILS_ENV=${env} bundle exec rails console"
  else
    command=''
  fi

  ssh -oStrictHostKeyChecking=accept-new unbounce@"$domain" \
    -t "cd /opt/lp-webapp/current && tmux new '$command'"
fi
